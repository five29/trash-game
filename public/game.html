<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ocean Cleanup Game</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<script>
let socket;
let players = {};
let trash = [];
let trashImages = [];
let particles = [];
let bubbles = [];
let fish = [];
let totalTrash = 50;
let netImage;
let backgroundImg;
let oceanSaved = false;
let savedTimer = 0;
let showScoreboard = false;
let countdown = 30;
let splash = true;
let shimmerX = 0;

function preload() {
  netImage = loadImage('net.png');
  backgroundImg = loadImage('background.png');
  for (let i = 1; i <= 6; i++) {
    trashImages.push(loadImage(`trash${i}.png`));
  }
}

function setup() {
  createCanvas(3840, 2160);
  socket = io();
  spawnTrash();
  generateFish();

  socket.on('playerJoined', ({ id, name }) => {
    players[id] = {
      color: [random(255), random(255), random(255)],
      name: name,
      score: 0,
      x: width / 2,
      y: height / 2,
      targetX: width / 2,
      targetY: height / 2,
      alpha: 0
    };
    splash = false;
  });

  socket.on('updateGame', ({ id, move }) => {
    if (players[id]) {
      players[id].targetX = move.x * width;
      players[id].targetY = move.y * height;
    }
  });

  socket.on('scoreUpdate', ({ id, score }) => {
    if (players[id]) {
      players[id].score = score;
    }
  });
}

function spawnTrash() {
  trash = [];
  const marginBottom = 200;
  for (let i = 0; i < totalTrash; i++) {
    trash.push({
      x: random(width),
      y: random(height - marginBottom),
      size: random(40, 60),
      img: random(trashImages),
      floatOffset: random(1000)
    });
  }
}

function generateFish() {
  fish = [];
  for (let i = 0; i < 20; i++) {
    fish.push({
      x: random(width),
      y: random(height),
      speed: random(0.5, 1.5),
      size: random(40, 80),
      color: color(random(100, 255), random(100, 255), random(100, 255))
    });
  }
}

function draw() {
  let progress = 1 - (trash.length / totalTrash);

  // --- BACKGROUND ---
  if (backgroundImg) {
    imageMode(CORNER);
    image(backgroundImg, 0, 0, width, height);
  } else {
    background(30, 60, 40);
  }

  // --- FOG LAYER ---
  let fogAmount = map(trash.length, 0, totalTrash, 0, 120);
  noStroke();
  fill(0, fogAmount);
  rect(0, 0, width, height);

  // --- PARTICLES + BUBBLES ---
  updateBubbles();
  updateParticles();

  // --- FISH LOOP ---
  for (let f of fish) {
    fill(f.color);
    noStroke();
    ellipse(f.x, f.y, f.size * 1.2, f.size);
    f.x += f.speed;
    if (f.x > width + f.size) {
      f.x = -f.size;
      f.y = random(height);
    }
  }

  // --- TRASH DRAWING ---
  imageMode(CENTER);
  for (let t of trash) {
    let floatY = sin(frameCount * 0.05 + t.floatOffset) * 5;
    let glowSize = t.size + 20;
    fill(0, 255, 200, 60);
    ellipse(t.x, t.y + floatY, glowSize);
    image(t.img, t.x, t.y + floatY, t.size, t.size);
  }

  // --- PLAYER DRAWING ---
  for (let id in players) {
    let p = players[id];
    p.x = lerp(p.x, p.targetX, 0.1);
    p.y = lerp(p.y, p.targetY, 0.1);
    if (p.alpha < 255) p.alpha += 5;

    if (frameCount % 6 === 0) {
      bubbles.push({
        x: p.x + random(-10, 10),
        y: p.y + 30,
        size: random(10, 20),
        life: 60,
        color: [200, 255, 255]
      });
    }

    if (frameCount % 5 === 0) {
      particles.push({ x: p.x, y: p.y, life: 60, color: p.color });
    }

    push();
    translate(p.x, p.y);
    tint(255, p.alpha);
    image(netImage, 0, 0, 100, 100);
    noTint();
    fill(255, p.alpha);
    noStroke();
    textAlign(CENTER);
    textSize(24);
    text(p.name, 0, -70);
    pop();

    for (let i = trash.length - 1; i >= 0; i--) {
      let t = trash[i];
      if (dist(p.x, p.y, t.x, t.y) < (50 + t.size / 2)) {
        trash.splice(i, 1);
        socket.emit('tryCollectTrash');
      }
    }
  }

  // --- PROGRESS BAR ---
  drawProgressBar(progress);

  // --- SPLASH SCREEN ---
  if (splash) drawSplashScreen();

  // --- SCOREBOARD LOGIC ---
  if (!oceanSaved && trash.length === 0) {
    oceanSaved = true;
    savedTimer = frameCount;
  }

  if (oceanSaved && frameCount > savedTimer + 60) {
    showScoreboard = true;
    savedTimer = frameCount;
  }

  // --- SCOREBOARD ---
  if (showScoreboard) drawScoreboard();
}

function updateBubbles() {
  for (let i = bubbles.length - 1; i >= 0; i--) {
    let b = bubbles[i];
    fill(b.color[0], b.color[1], b.color[2], map(b.life, 0, 60, 0, 180));
    noStroke();
    ellipse(b.x, b.y, b.size);
    b.y -= 0.5;
    b.size *= 0.98;
    b.life -= 1;
    if (b.life <= 0) {
      bubbles.splice(i, 1);
    }
  }
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    let p = particles[i];
    fill(p.color[0], p.color[1], p.color[2], map(p.life, 0, 60, 0, 255));
    noStroke();
    ellipse(p.x, p.y, 10);
    p.life -= 2;
    if (p.life <= 0) {
      particles.splice(i, 1);
    }
  }
}

function drawProgressBar(progress) {
  const barWidth = width * 0.8;
  const barHeight = 40;
  const x = width / 2 - barWidth / 2;
  const y = height - 100;

  shimmerX += 10;
  if (shimmerX > barWidth) shimmerX = -200;

  noFill();
  stroke(0, 255, 200, 100);
  strokeWeight(6);
  rect(x - 4, y - 4, barWidth + 8, barHeight + 8, 30);

  noStroke();
  fill(0, 50, 70, 180);
  rect(x, y, barWidth, barHeight, 20);

  let fillColor = lerpColor(color(255, 50, 100), color(0, 255, 150), progress);
  fill(fillColor);
  rect(x, y, barWidth * progress, barHeight, 20);

  fill(255, 255, 255, 80);
  rect(x + shimmerX, y, 100, barHeight, 20);

  fill(255);
  noStroke();
  textSize(32);
  textAlign(CENTER, BOTTOM);
  text(`Ocean Cleanup: ${Math.floor(progress * 100)}%`, width / 2, y - 10);
}

function drawSplashScreen() {
  fill(0, 180);
  rect(0, 0, width, height);
  fill(255);
  textAlign(CENTER, CENTER);
  textSize(80);
  text("ðŸŒŠ OCEAN CLEANUP ðŸŒŠ", width / 2, height / 2 - 100);
  textSize(40);
  text("Waiting for players to join...", width / 2, height / 2 + 20);
}

function drawScoreboard() {
  fill(0, 200);
  rect(0, 0, width, height);
  fill(255);
  textAlign(CENTER, CENTER);
  textSize(80);
  text("ðŸŒŸ Ocean Saved! ðŸŒŸ", width / 2, 100);

  textSize(40);
  let sortedPlayers = Object.values(players).sort((a, b) => b.score - a.score);
  let startY = 250;
  for (let i = 0; i < sortedPlayers.length; i++) {
    let p = sortedPlayers[i];
    text(`${i + 1}. ${p.name} - ${p.score} trash collected`, width / 2, startY + i * 60);
  }

  textSize(30);
  text(`Next game starting in ${countdown} seconds...`, width / 2, height - 100);

  if (frameCount % 60 === 0) {
    countdown--;
    if (countdown <= 0) {
      showScoreboard = false;
      oceanSaved = false;
      countdown = 30;
      for (let id in players) {
        players[id].score = 0;
        players[id].alpha = 0;
      }
      spawnTrash();
      generateFish();
      splash = true;
    }
  }
}
</script>
</body>
</html>
